#!/bin/bash

#rpm-check

#Queries a uninstalled rpm for descripton, listing
#and whether it can be installed.
#Saves the output to a logfile which can be inspected afterwards.
#For installed ones use the rpm command.
#Note that this script only works for rpm-based distributions

#Comes with the package Bash-Tools
#Ideas collected by Mendel Cooper (Advanced Bash Scripting Guide)
#Rewritten for opensuse 10.2 by Matthias Propst



##VARS
NO_RPM=33
NO_ARGS=65
IS_INSTALLABLE=0
##VARS

###functions begin here

#trap for signal 2
trapint ()
{
echo "Do not press crtl+c"
}

###functions end here

#checks if the script has an argument
if [ -z "$*" ]
then
echo "Usage: `basename $0` rpm-file. Or just type `basename $0` *rpm to collect the information"
echo "from every rpm file you might find in the current working directory."
exit $NO_ARGS
fi

read -p "Please specify the file to which you want to save the output:" FILE_OUTPUT
${FILE_OUTPUT:="rpm.test"} 2> /dev/null

#clears existing outputfile
if [ -f $FILE_OUTPUT ]
then
cat /dev/null > $FILE_OUTPUT
fi

echo -e '\E[31mPlease be patient'; tput sgr0

#prevent the sigint signal
trap trapint 2

{
echo
echo "File was generated by $0"
} >> rpm.test1

#Checks whether the first argument is an rpm
for rpm in $*
do

if [ ${rpm##*.} != "rpm" ]
then
echo "Not a rpm file"
exit $NO_RPM
else
	if [ ! -f $rpm ]
	then
	echo "Not a rpm file"
	exit $NO_RPM 
	fi
	
fi

ls $rpm

	{ #begin of codeblock
	echo
	echo "======================================================================================================="
	echo "Check for $rpm"
	echo "======================================================================================================="
	echo "Archive Description"
	rpm -qpi $rpm #Query Description look at man rpm to find out more.
	echo
	echo "Archive Listing"
	rpm -qpl $rpm #Query Listing
	echo $rpm
	echo "Install check"
	rpm -U --test $rpm 2>> rpm.test2  #Checks whether the rpm can be installed

		if [ "$?" -eq $IS_INSTALLABLE ]
		then
		echo "$rpm can be installed"
		else
		echo "$rpm cannot be installed."
		fi

	echo 
	echo "rpm integretycheck for $rpm: "
	rpmlint --version && rpmlint -i $rpm #this will be skipped if rpmlint is not installed
	echo "======================================================================================================="
	echo "======================================================================================================="
	echo
	} >> rpm.test1 #ends codeblock and writes output to the logfile
done

cat rpm.test1 rpm.test2 > $FILE_OUTPUT

rm rpm.test1
rm rpm.test2
clear
echo -e  '\E[32mdone'; tput sgr0
echo "Results of rpm test in file $FILE_OUTPUT"

exit 0
